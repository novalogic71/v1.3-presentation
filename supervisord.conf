# =============================================================================
# Supervisord Configuration for Docker Deployment
# =============================================================================
# This file is used inside Docker containers. For native deployments,
# the start_all.sh script generates a runtime config automatically.
# =============================================================================

[supervisord]
nodaemon=true
logfile=/app/logs/supervisord.log
logfile_maxbytes=10MB
logfile_backups=3
loglevel=info
pidfile=/tmp/supervisord.pid

[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[program:fastapi]
command=python /app/fastapi_app/main.py
directory=/app/fastapi_app
autostart=true
autorestart=true
startsecs=10
startretries=5
stopwaitsecs=30
stdout_logfile=/app/logs/fastapi.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/fastapi_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
environment=PYTHONPATH="/app:/app/fastapi_app",PYTHONUNBUFFERED="1",DEBUG="false"

[program:celery]
command=celery -A app.core.celery_app worker --loglevel=info --concurrency=4 --hostname=sync-worker@%%h
directory=/app/fastapi_app
autostart=true
autorestart=true
startsecs=10
startretries=5
stopwaitsecs=30
stopasgroup=true
killasgroup=true
stdout_logfile=/app/logs/celery.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/celery_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
environment=PYTHONPATH="/app:/app/fastapi_app",PYTHONUNBUFFERED="1"

[eventlistener:process_exit]
command=python /app/scripts/supervisor_eventlistener.py
events=PROCESS_STATE_FATAL,PROCESS_STATE_EXITED
autostart=true
autorestart=unexpected
stdout_logfile=/app/logs/eventlistener.log

